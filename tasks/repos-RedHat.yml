---
- name: Check if repo package for "{{ item.name }}" is installed
  yum:
    list="{{ item.package_name }}"
  register: is_installed
  # when:
  #   - item.repo_install == True

- name: debug repo_status
  debug: msg="{{ is_installed.results|selectattr("yumstate", "match", "installed")|list|length }}"
  tags:
    - debug

- name: "Installing repo for {{ item.repo_name }}"
  yum:
    name: "{{ item.repo_rpm }}"
    state: present
    update_cache: yes
  ignore_errors: "{{ ansible_check_mode }}"
  when:
    - is_installed.results|selectattr("yumstate", "match", "installed")|list|length == 0
    - item.repo_install == True

- name: "Install GPG key for repo {{ item.name }}"
  rpm_key:
    key: "{{ item.gpg_key_url }}"
    state: present
  ignore_errors: "{{ ansible_check_mode }}"
  when:
    - item.gpg_key_url is defined
    - item.repo_install == True

- name: "Enable repo {{ item.name }}"
  yum_repository:
    name: "{{ item.repo_id }}"
    enabled: yes
  ignore_errors: "{{ ansible_check_mode }}"
  when:
    - item.repo_enable == True
    - is_installed == True

- name: "Enable GPG check for repo {{ item.name }}"
  yum_repository:
    name: "{{ item.repo_id }}"
    gpgcheck: yes
    gpgkey: "{{ item.gpg_key_url }}"
  ignore_errors: "{{ ansible_check_mode }}"
  when:
    - is_installed == True
    - item.gpg_key_url is defined

- include:
    packages-ius.yml
  when:
    - item.name == "ius"
    - is_installed.results|selectattr("yumstate", "match", "installed")|list|length == 1

- include:
    packages-elrepo.yml
  when:
    - item.name == "elrepo"
    - is_installed.results|selectattr("yumstate", "match", "installed")|list|length == 1
